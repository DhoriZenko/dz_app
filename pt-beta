#!/bin/bash

# --- YOUR CONFIGURATION ---
# These match the details you requested.
DB_PASSWORD="Ted70900!"
ADMIN_EMAIL="frozenfox909@gmail.com"
DOMAIN="zen.dhorizenko.com"
PANEL_USER="dhorizenko"
PANEL_PASS="Ted70900!"
# --------------------------

set -e # Exit if any command fails

echo "--- STARTING AUTOMATED INSTALL FOR $DOMAIN ---"

# 1. Install System Dependencies (PHP 8.3)
echo "[1/7] Installing System Dependencies..."
apt update -y && apt upgrade -y
apt -y install software-properties-common curl apt-transport-https ca-certificates gnupg

# Add Repositories
LC_ALL=C.UTF-8 add-apt-repository -y ppa:ondrej/php
curl -fsSL https://packages.redis.io/gpg | sudo gpg --dearmor -o /usr/share/keyrings/redis-archive-keyring.gpg --yes
echo "deb [signed-by=/usr/share/keyrings/redis-archive-keyring.gpg] https://packages.redis.io/deb $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/redis.list
curl -LsS https://r.mariadb.com/downloads/mariadb_repo_setup | sudo bash

apt update -y
apt -y install php8.3 php8.3-{common,cli,gd,mysql,mbstring,bcmath,xml,fpm,curl,zip,intl} mariadb-server nginx tar unzip git redis-server

# Install Composer v2
curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer

# 2. Database Setup
echo "[2/7] Setting up Database..."
systemctl start mariadb
# Create DB and User silently
sudo mysql -u root -e "CREATE USER IF NOT EXISTS 'pterodactyl'@'127.0.0.1' IDENTIFIED BY '$DB_PASSWORD';"
sudo mysql -u root -e "CREATE DATABASE IF NOT EXISTS panel;"
sudo mysql -u root -e "GRANT ALL PRIVILEGES ON panel.* TO 'pterodactyl'@'127.0.0.1' WITH GRANT OPTION;"
sudo mysql -u root -e "FLUSH PRIVILEGES;"

# 3. Download Panel Files
echo "[3/7] Downloading Panel..."
mkdir -p /var/www/pterodactyl
cd /var/www/pterodactyl
curl -Lo panel.tar.gz https://github.com/pterodactyl/panel/releases/latest/download/panel.tar.gz
tar -xzvf panel.tar.gz
chmod -R 755 storage/* bootstrap/cache/

# 4. Configure Environment (Bypass Wizards)
echo "[4/7] configuring .env file automatically..."
cp .env.example .env
COMPOSER_ALLOW_SUPERUSER=1 composer install --no-dev --optimize-autoloader

# Inject credentials into .env
sed -i "s|^APP_URL=.*|APP_URL=http://$DOMAIN|g" .env
sed -i "s|^DB_PASSWORD=.*|DB_PASSWORD=$DB_PASSWORD|g" .env
sed -i "s|^DB_HOST=.*|DB_HOST=127.0.0.1|g" .env
sed -i "s|^DB_PORT=.*|DB_PORT=3306|g" .env
sed -i "s|^DB_DATABASE=.*|DB_DATABASE=panel|g" .env
sed -i "s|^DB_USERNAME=.*|DB_USERNAME=pterodactyl|g" .env
sed -i "s|^CACHE_DRIVER=.*|CACHE_DRIVER=redis|g" .env
sed -i "s|^SESSION_DRIVER=.*|SESSION_DRIVER=redis|g" .env
sed -i "s|^QUEUE_CONNECTION=.*|QUEUE_CONNECTION=redis|g" .env

# Generate Key
php artisan key:generate --force

# Run Migrations
echo "Running Database Migrations..."
php artisan migrate --seed --force

# 5. Create Admin User (Automated)
echo "[5/7] Creating Admin User: $PANEL_USER..."
php artisan p:user:make \
  --email="$ADMIN_EMAIL" \
  --username="$PANEL_USER" \
  --name-first="Admin" \
  --name-last="User" \
  --password="$PANEL_PASS" \
  --admin=1 \
  --no-interaction

# Set Permissions
chown -R www-data:www-data /var/www/pterodactyl/*

# 6. Service & NGINX Setup
echo "[6/7] Generating Service Configs..."

# Queue Worker Service
cat <<EOF > /etc/systemd/system/pteroq.service
[Unit]
Description=Pterodactyl Queue Worker
After=redis-server.service

[Service]
User=www-data
Group=www-data
Restart=always
ExecStart=/usr/bin/php /var/www/pterodactyl/artisan queue:work --queue=high,standard,low --sleep=3 --tries=3
StartLimitInterval=180
StartLimitBurst=30
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF

# Enable Services
systemctl enable --now redis-server
systemctl enable --now pteroq.service

# Cron Job
(crontab -l 2>/dev/null; echo "* * * * * php /var/www/pterodactyl/artisan schedule:run >> /dev/null 2>&1") | crontab -

# NGINX Config
cat <<EOF > /etc/nginx/sites-available/pterodactyl.conf
server {
    listen 80;
    server_name $DOMAIN;

    root /var/www/pterodactyl/public;
    index index.php;

    access_log /var/log/nginx/pterodactyl.app-access.log;
    error_log  /var/log/nginx/pterodactyl.app-error.log error;

    client_max_body_size 100m;
    client_body_timeout 120s;

    sendfile off;

    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/run/php/php8.3-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param PHP_VALUE "upload_max_filesize = 100M \n post_max_size = 100M";
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
        fastcgi_param HTTP_PROXY "";
        fastcgi_intercept_errors off;
        fastcgi_buffer_size 16k;
        fastcgi_buffers 4 16k;
        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
        fastcgi_read_timeout 300;
    }

    location ~ /\.ht {
        deny all;
    }
}
EOF

rm -f /etc/nginx/sites-enabled/default
ln -s /etc/nginx/sites-available/pterodactyl.conf /etc/nginx/sites-enabled/pterodactyl.conf
systemctl restart nginx

# 7. Install Wings (Docker)
echo "[7/7] Installing Wings..."
curl -sSL https://get.docker.com/ | CHANNEL=stable bash
systemctl enable --now docker
sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="\(.*\)"/GRUB_CMDLINE_LINUX_DEFAULT="\1 swapaccount=1"/g' /etc/default/grub 
update-grub

mkdir -p /etc/pterodactyl
curl -L -o /usr/local/bin/wings "https://github.com/pterodactyl/wings/releases/latest/download/wings_linux_$([[ "$(uname -m)" == "x86_64" ]] && echo "amd64" || echo "arm64")"
chmod u+x /usr/local/bin/wings

# Create Wings Service
cat <<EOF > /etc/systemd/system/wings.service
[Unit]
Description=Pterodactyl Wings Daemon
After=docker.service
Requires=docker.service
PartOf=docker.service

[Service]
User=root
WorkingDirectory=/etc/pterodactyl
LimitNOFILE=4096
PIDFile=/var/run/wings/daemon.pid
ExecStart=/usr/local/bin/wings
Restart=on-failure
StartLimitInterval=180
StartLimitBurst=30
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF

systemctl enable --now wings

echo "----------------------------------------------------"
echo "INSTALLATION COMPLETE!"
echo "Panel URL: http://$DOMAIN"
echo "User: $PANEL_USER"
echo "Pass: $PANEL_PASS"
echo "this is a beta script"
echo "----------------------------------------------------"
